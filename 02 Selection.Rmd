---
title: "02 Selection"
author: '35762384'
date: "17/02/2021"
output: 
  pdf_document 
   
---  
```{r, include=FALSE}
library(sf)
library(readxl)
library(dplyr)
library(plyr)
library(ggplot2)
library(afrihealthsites)
library(ggpubr)
library(afriadmin)
library(tmap)
library(forcats)
library(cowplot)
library(colorspace)
library(readr)
library(waffle)
library(sunburstR)
library(htmltools)
library(htmlwidgets)
library(rhealthsites)
library(formattable)
library(gridExtra)

# Install Malawi MFL
malawi_MFL = read_excel("~/malawi-health-facilities-1/MHFR_Facilities 1.xlsx")

# Convert to sf

## omit NA's
new_malawi_MFL = na.omit(malawi_MFL)

## transform geometry columns into numeric 
new_malawi_MFL = transform(new_malawi_MFL, LATITUDE = as.numeric(LATITUDE), 
                                           LONGITUDE = as.numeric(LONGITUDE))

## convert to sf object
malawi_facilities_MFL = st_as_sf(new_malawi_MFL, coords = c("LONGITUDE", "LATITUDE"), dim = "XY")

malawi_facilities_MFL = st_set_crs(malawi_facilities_MFL, 4326)

# Install WHO-KWTRP
malawi_WHO <- afrihealthsites("malawi", datasource='who', plot=FALSE, returnclass='dataframe')
malawi_WHO = malawi_WHO[ , -10]

new_malawi_WHO = na.omit(malawi_WHO) ## omit NA

sf_malawi_WHO = st_as_sf(new_malawi_WHO, coords = c("Long", "Lat"), dim = "XY")
sf_malawi_WHO = st_set_crs(sf_malawi_WHO, 4326)

# Install admin levels 
malawi_admin1 = afriadmin("malawi", level = 1, plot = "sf")
malawi_admin2 = afriadmin("malawi",level=2, plot='sf')

# Install healthsites from afrihealthsites
malawi_healthsites <- afrihealthsites("malawi", datasource='healthsites', plot=FALSE, returnclass='dataframe')

## See if its different from rhealthsites package
hs_set_api_key("d426d9b2b210263c3f6fe924161a3d9ac293a6fe")
malawi_rhs = hs_facilities(country = "Malawi") # has 247 facilities, matches website

# Compare the 2 
malawi_rhs_noSF = st_set_geometry(malawi_rhs, NULL)
malawi_healthsites_noSF = st_set_geometry(malawi_healthsites, NULL)
# using anti_join = Mostly different, only 15 are the same 
# use rhealthsites, matches with website

malawi_admin3 = afriadmin("malawi",level=3, plot='sf')
tmap_mode("plot")
```  
  
#### Introduction  

The availability of health facility data, such as location, capacity and resources present, is an important factor needed for decision-making processes, especially in the ongoing COVID-19 pandemic. Examples of uses include planning of interventions, disease surveillance, information for insurance companies and health management information systems (HMIS) (WHO, 2018). It is also often used for research purposes, with many studies utilising facility data to determine accessibility to healthcare or travel times (Hulland et al., 2019). However, availability is often not the issue but the fact that there are multiple sources and the discrepancies between them (Makinde et al., 2018). It is common for different organisations, e.g. non-governmental organisations (NGOs), government departments and other non-profit organisations, to produce their own lists and a need to further investigate differences is noted in studies using this data (Hulland, 2020). The aim of this paper is to do address this point; to analyse and highlight the differences between sources of facility data using Malawi as a case study and mark areas for improvement in the quality of the data.

One source for Malawi is a list compiled by the Kenyan Wellcome Trust Research Programme (KWTRP) for 50 sub-Saharan African countries and was released in 2019 (Maina et al., 2019). It focused on public health facilities, those run by the government, faith-based organisations (FBOs) and NGOs and also removed facilities that only provide specialised care such as psychiatry. It’s availability as open-access data as well as the thorough cleaning and validation processes implemented, meant it is often cited in other studies (Falchetta et al., 2020) (Judson et al., 2020) (Dowhaniuk, 2021) (Wariri et al., 2021). Several sources of information for facilities were combined to produce one list and in the case of Malawi, personal communication with health related organisations, data from The Humanitarian Data Exchange (HDX) and The Christian Health Association of Malawi (CHAM) were used (Maina et al., 2019). An important note is that the years of when the information was acquired from these sources vary, with the most recent being 2017 and the personal communication being conducted in 2013. The list is now being hosted by the World Health Organisation (WHO) Global Malaria Programme with the aim to update (WHO, 2019). However, since the publication of this study, there have been no updates or changes. Therefore, there is a need to compare with other sources, especially as the age of this data might mean new developments are not captured which could affect the study’s popularity. 

A newer source is the Master Facility List (MFL) from and managed by the Malawi Ministry of Health (MOH, 2021). The WHO recommends that every country produces a MFL with the aim of it being the primary source and describes how to develop it in (WHO, 2019). It must be accessible, regularly updated and validated. Although many African countries have made steps towards formulating a MFL under these guidelines, issues of access and missing elements are often 
encountered, making its usage more difficult (South et al., 2021). With Malawi, the MFL is openly available.However, its validation methods are not made clear and information on the most recent update is only available when selecting a specific facility and is not part of the dataset that can be downloaded. Despite this, the fact that is maintained by the Ministry of Health and so has the potential to be incorporated into the health system and that it is a more recent source, it is worth investigating how this list compares to others. 

Other sources are mostly dependent on information contributed by volunteers, of which healthsites.io is a global project aiming to map every health facility running (Healthsites, 2021). It works with OpenStreetMap, which provides the baseline map as well as the methods to input data, and since its establishment in 2016 has recorded over 900,000 facilities. Anyone can contribute and effort has been put into validation processes, which includes a Location Validation Index, a score that reflects other users verifying that facility exists. The data is freely available and access to the most recent version can be gained through several formats such as an API. Other lists can also be incorporated into healthsites.io and there is a process outlined for the import of facility lists from national ministries of health. However, similarly with other lists, it struggles with completeness and it has been shown that less than 2% of healthsites.io data for sub-Saharan Africa contains attributes describing capacity (South et al., 2021). It seems that the quality or functionality of these lists is limited across all of these sources. 

Quality data is important but this is often neglected or not investigated. There are several issues that are prominent with facility data from sub-Saharan Africa. Lists are often missing key elements such as capacity, equipment and services they provide. Not only this, problems with missing coordinates can also occur, with the WHO-KWTRP data reporting 9 missing coordinates for Malawi (Maina et al., 2019). These issues are present but there is not much research highlighting this, especially when comparing between sources, but this is important for studies that go on to utilise these lists. The outbreak of COVID-19 brought a greater emphasis on the need for this. Several countries have allowed open access to their facility data, encouraging external research to aid the response to the pandemic and improvement of the data itself . For example, research investigating the ability of health facilities to increase capacity and the identification of people vulnerable due to various factors in Kenya were performed with open facility data (Barasa et al., 2020) (Macharia et al., 2020). Therefore, maintenance and quality control of facility lists are essential in providing accurate data and contributing to valid research. 

The aim for this paper is to provide a reproducible summary of facility data for Malawi, discuss differences that are relevant to potential stakeholders and make apparent areas for improvement. The following hypotheses have been developed to address this: 

1.	The same number of health facility locations are recorded for Malawi across healthsites.io, WHO-KWTRP and their MFL
2.	The health facility locations and proportion of facility types recorded in the Malawi MFL are similar to those being used in current global analyses
3.	Hospital locations stored in healthsites.io are currently not a good representation of those available from the Malawi MFL


##### Methods  
- Websites from where I downloaded  
- What was done to the data pre-analysis, e.g. removing NAs  
- Software used (packages?)  

##### Results  

The data downloaded contained 1546 facilities in the MFL, 648 in the WHO-KWTRP list for Malawi and 248 in healthsites.io. After removal of missing coordinates and duplicates, there are 1424, 638 and 234 facilities in the MFL, WHO-KWTRP and healthsites.io data respectively (figure 1). The MFL contains more than 6 times the number of facilities compared to healthsites.io.  

```{r Number of facilities, echo=FALSE, fig.cap="Total number of facilities recorded in each data source."}
## table
Sources = c("MFL", "WHO-KWTRP", "healthsites.io")
Number = c(1424, 638, 234)
number_3sources = data.frame(Sources, Number)

# plot
plot_3sources = ggplot(number_3sources, aes(x=Sources, y=Number)) + geom_bar(stat = "identity", width = 0.6, fill="slategray") + labs(x = "Source of data", y = "Frequency") + theme_minimal() + expand_limits(y=c(0,1500)) + coord_flip()
plot_3sources
```

Both the MFL and WHO-KWTRP contain some missing coordinates. Upon inspection, there are 119 missing values and 62 coordinates that are not in Malawi, which were either inputted incorrectly or not known, in the MFL. In the WHO-KWTRP, there are 9 missing coordinates and this was stated in (Maina et al., 2019). Healthsites.io carries some missing attributes but all coordinates are present and reside within Malawi. Analysis into duplicates within lists shows that names for 5 facilities in the MFL were duplicated at least once and these also have similar coordinates up to at least 2 decimal places. Of these 5 facilities, 3 share the same entries in the other attribute columns while the remaining 2 differ in type. In the WHO-KWTRP, 1 health centre appears twice with the same attributes and coordinates. With healthsites.io, there are 18 names that were inputted more than once and all apart from 2 have similar coordinates up to at least 2 decimal places. Searching for duplicate coordinates rather than names also gave matches. In healthsites.io, 4 facilities that were also part of the previous 18 have identical coordinates. The time stamp on these facilities indicate that their duplicates were inputted at the exact same time. The WHO-KWTRP list does not have duplicates while the MFL returned 44 distinct coordinates that were repeated at least more than once. One of these cases is repetition of one location for 24 facilities, of different types and names, in Blantyre. However, some results are due to no coordinates being available and for example, (-1,1) was recorded instead.  

```{r NAs in data, include=FALSE}
# MFL - 1546 before omitting NA's, then 1427.
# 62 coordinates did not intersect with admin data - now 1365

# using anti_join() to see which facilities were omitted 
df_malawi_facilities_MFL = as.data.frame(malawi_facilities_MFL) # convert to data frame to use in anti_join

NA_MFL = anti_join(malawi_MFL, df_malawi_facilities_MFL) # 119 missing coordinates in MFL

# adding the number of wrong coordinates - 61
intersect_admin1_MFL = st_intersection(malawi_facilities_MFL, malawi_admin1) # returns data frame of matches

intersect_admin1_MFL = as.data.frame(intersect_admin1_MFL) # convert to data frame to use in anti_join

no_intersect_admin1_MFL = anti_join(malawi_facilities_MFL, intersect_admin1_MFL) # working out which facilities did not intersect

no_intersect_admin1_MFL_1 = no_intersect_admin1_MFL[ ,-c(10, 11)]
NA_MFL_1 = NA_MFL[, -c(10, 11)]
no_intersect_admin1_MFL_1 = st_set_geometry(no_intersect_admin1_MFL_1, NULL)
names(NA_MFL_1)[3] = "COMMON.NAME"
names(NA_MFL_1)[9] = "DATE.OPENED"

NA_MFL = rbind(NA_MFL_1, no_intersect_admin1_MFL_1) # combined dataframe of NA and wrong coordinates in MFL

# WHO - 648 with 9 missing coordinates, now 639
NA_WHO = anti_join(malawi_WHO, new_malawi_WHO)

## 
NA_MFL_district = as.data.frame(table(NA_MFL_1$DISTRICT))
NA_MFL_district

malawi_MFL_district = as.data.frame(table(new_malawi_MFL$DISTRICT))
malawi_MFL_district
```  
  
Figure 1 shows method and number of duplicate data points that have been removed as part of the analysis. As discussed, duplicates are considered by name or coordinates. If the coordinates and main attributes match, the duplicate is removed. Therefore, majority of facilities with duplicate coordinates in the MFL were not removed due to possessing different names or were of different types. Any missing coordinates were also omitted before further analysis. The 62 incorrect coordinates in the MFL were kept and not included in this.  

```{r Duplicates, include=FALSE}
# MFL
duplicate_name_MFL = malawi_facilities_MFL[malawi_facilities_MFL$NAME %in% malawi_facilities_MFL$NAME[duplicated(malawi_facilities_MFL$NAME)], ]
# Ngatala Health Post, Cape Maclear, LIFE STYLE PVT CLINIC

# WHO 
duplicate_name_WHO = new_malawi_WHO[new_malawi_WHO$`Facility name` %in% new_malawi_WHO$`Facility name`[duplicated(new_malawi_WHO$`Facility name`)], ]
# Mkango Health Centre

# healthsites
duplicate_name_rhs = malawi_rhs[malawi_rhs$name %in% malawi_rhs$name[duplicated(malawi_rhs$name)], ]
malawi_rhs$name[duplicated(malawi_rhs$name)]

# Misuku (time is different, 4 decimal places), AREA18 (time is same, 5 decimal), Leo pharm (mostly diff, 3 decimal), Care (identical), Likuni (same, 5 decimal), Nakalanzi (different, 2 dec), Kamuzu (2 same user, all diff coord), pharmcare (identical), one stop (diff coord), mwalingo (diff, 3 dec), nsambe (same, 4 dec), good hope (identical), nakalanzi (diff, 2 dec), health (same, 1 dec), chanc (diff, 4 dec), lifuwu (diff, 3 dec), nkombezi (same, 3 dec), Nkhoma Eye Clinic (identical)

# remove: Misuku health centre, AREA18 (same time), Leo pharm(diff time&person), Care Polyclinic Limited, Likuni Drug Store, Nakalanzi Health Centre(diff time), Pharmcare, Mwalingo Private Hospital(diff time), Nsambe Rural Health Center, Good hope pvt clinic, Chancellor College Clinic (diff time&person), Nkombezi Clinic(diff time), Nkhoma Eye Clinic 

# Same coordinates within dataset

## MFL 
duplicate_coord_MFL = malawi_facilities_MFL[malawi_facilities_MFL$geometry %in% malawi_facilities_MFL$geometry[duplicated(malawi_facilities_MFL$geometry)], ]

duplicated(duplicate_coord_MFL$NAME)

## WHO 
sf_malawi_WHO$geometry[duplicated(sf_malawi_WHO$geometry)] # none

## healthsites 
duplicate_coord_rhs = malawi_rhs[malawi_rhs$geometry %in% malawi_rhs$geometry[duplicated(malawi_rhs$geometry)], ]
malawi_rhs$geometry[duplicated(malawi_rhs$geometry)]
```

```{r Removing duplicates, include=FALSE}
# removing duplicates MFL
which(malawi_MFL[,2] == "Ngatala Health Post") #1160 1164
which(malawi_MFL[,2] == "Cape Maclear") # 1516 1526
which(malawi_MFL[,2] == "LIFE STYLE PVT CLINIC") # 1522 1523

malawi_MFL = malawi_MFL[-c(1160, 1516, 1522), ]

# Convert to sf

## omit NA's
new_malawi_MFL = na.omit(malawi_MFL)

## transform geometry columns into numeric 
new_malawi_MFL = transform(new_malawi_MFL, LATITUDE = as.numeric(LATITUDE), 
                                           LONGITUDE = as.numeric(LONGITUDE))

## convert to sf object
malawi_facilities_MFL = st_as_sf(new_malawi_MFL, coords = c("LONGITUDE", "LATITUDE"), dim = "XY")

malawi_facilities_MFL = st_set_crs(malawi_facilities_MFL, 4326)

# removing duplicates WHO
which(malawi_WHO[,3] == "Mkango Health Centre") # 523 524

malawi_WHO = malawi_WHO[-523, ]


new_malawi_WHO = na.omit(malawi_WHO) ## omit NA

sf_malawi_WHO = st_as_sf(new_malawi_WHO, coords = c("Long", "Lat"), dim = "XY")
sf_malawi_WHO = st_set_crs(sf_malawi_WHO, 4326)

# removing duplicates healthsites.io
which(malawi_rhs$name == "Misuku Health Centre") # 3 86
which(malawi_rhs$name == "AREA18 mediclinic") # 35 47
which(malawi_rhs$name == "Leo Pharmacy") # 44 65
which(malawi_rhs$name == "Care Polyclinic Limited") # 49 60
which(malawi_rhs$name == "Likuni Drug Store") #  55 110
which(malawi_rhs$name == "Nakalanzi Health Centre") # 66 149
which(malawi_rhs$name == "Pharmcare") # 70 96
which(malawi_rhs$name == "Mwalingo Private Hospital") # 104 188
which(malawi_rhs$name == "Nsambe Rural Health Center") # 107 211
which(malawi_rhs$name == "Good hope pvt clinic") # 127 158
which(malawi_rhs$name == "Chancellor College Clinic") # 166 177
which(malawi_rhs$name == "Nkombezi Clinic") # 216 247
which(malawi_rhs$name == "Nkhoma Eye Clinic") #59 85

malawi_rhs = malawi_rhs[-c(3, 35, 44, 49, 55, 66, 70, 104, 107, 127, 166, 216, 59), ]

# figure 1 
## healthsites
facility.name.rhs = c("Misuku Health Centre", "AREA18 mediclinic", "Leo Pharmacy", "Care Polyclinic Limited", "Likuni Drug Store", "Nakalanzi Health Centre", "Pharmcare", "Mwalingo Private Hospital", "Nsambe Rural Health Center", "Good hope pvt clinic", "Chancellor College Clinic", "Nkombezi Clinic", "Nkhoma Eye Clinic")
coordinates.rhs = c("33.5208265800223, -9.67965073595659", "33.7706302287404, -13.9445974818355", "33.766769724044, -13.9878648128351", "33.7638450265697, -13.9903576746579", "33.7125379723211, -14.0263392571441", "34.5490414316588, -14.2017512005316", "33.7688361984524, -13.987080182879", "33.5327068381233, -9.6695534762986", "34.6136477193225, -15.2615526872826", "33.7642675583087, -14.0066068321501", "35.3321704544042, -15.3855159746797", "34.8818326595846, -16.2777391528508", "33.7812221367719, -13.9949903525419")
input.rhs = replicate(13, 2)
reason.rhs = c("Same type and name. Coordinates identical up to 4 decimal places", "Same type, name and time inputted. Coordinates identical up to 5 decimal places", "Same type and name. Coordinates identical up to 3 decimal places", "Same type, name and time inputted. Coordinates are identical", "Same type, name and time inputted. Coordinates identical up to 5 decimal places", "Same type and name. Coordinates identical up to 2 decimal places", "Same type, name and time inputted. Coordinates are identical", "Same type and name. Coordinates identical up to 3 decimal places", "Same type, name and time inputted. Coordinates identical up to 4 decimal places", "Same type, name and time inputted. Coordinates are identical", "Same type and name. Coordinates identical up to 4 decimal places", "Same type and name. Coordinates identical up to 3 decimal places", "Same type, name and time inputted. Coordinates are identical")

healthsites.rmvd = data.frame(facility.name.rhs, coordinates.rhs, input.rhs, reason.rhs)

## MFL
facility.name.mfl = c("Ngatala Health Post", "Cape Maclear", "LIFE STYLE PVT CLINIC")
coordinates.mfl = c("35.07712, -14.65773", "2, -1", "3, -2")
input.mfl = replicate(3, 2)
reason.mfl = c("Same attributes. Coordinates identical up to 3 decimal places", "Same attributes except 'Common name'. Coordinates are identical", "Same attributes except 'Common name'. Coordinates are identical")

mfl.rmvd = data.frame(facility.name.mfl, coordinates.mfl, input.mfl, reason.mfl)

## WHO-KWTRP
facility.name.who = "Mkango Health Centre"
coordinates.who = "35.27031, -16.73075"
input.who = 2
reason.who = "Same attributes. Coordinates are identical up to 4 decimal places"

who.rmvd = data.frame(facility.name.who, coordinates.who, input.who, reason.who)

## formatting
healthsites.rmvd$Facility.name = healthsites.rmvd$facility.name.rhs
healthsites.rmvd$Coordinates = healthsites.rmvd$coordinates.rhs
healthsites.rmvd$No.of.inputs = healthsites.rmvd$input.rhs
healthsites.rmvd$Reason = healthsites.rmvd$reason.rhs

healthsites.rmvd = healthsites.rmvd[ ,-c(1:4)]

mfl.rmvd$Facility.name = mfl.rmvd$facility.name.mfl
mfl.rmvd$Coordinates = mfl.rmvd$coordinates.mfl
mfl.rmvd$No.of.inputs = mfl.rmvd$input.mfl
mfl.rmvd$Reason = mfl.rmvd$reason.mfl

mfl.rmvd = mfl.rmvd[ , -c(1:4)]

who.rmvd$Facility.name = who.rmvd$facility.name.who
who.rmvd$Coordinates = who.rmvd$coordinates.who
who.rmvd$No.of.inputs = who.rmvd$input.who
who.rmvd$Reason = who.rmvd$reason.who

who.rmvd = who.rmvd[ , -c(1:4)]

### bind

rmvd.facilities = rbind(who.rmvd, mfl.rmvd, healthsites.rmvd)

rmvd.facilities$Source = c("WHO", "MFL", "MFL", "MFL", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io", "healthsites.io")
```

```{r figure 1, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Table of duplicate facilities removed from each source. 'No.of.inputs' refers to number of times that facility was duplicated and rationale is reported under 'reason'."}

grid.table(rmvd.facilities)
```
  

##### Hypothesis 2  

With the WHO-KWTRP list often used in research, a comparison to the MFL is made here. Setting aside the groups of unclassified and private in the MFL, both the MFL and WHO-KWTRP have similar numbers of classification types (figure 2). However, there is a difference in the amount of specificity. The WHO-KWTRP provides 5 categories for hospitals while the MFL only provides 3. In contrast, the MFL separates health posts and dispensaries while WHO-KWTRP combines these facilities. The private and unclassified groups not present in WHO-KWTRP only make up 0.4% of the number of facilities in the MFL. Much of the variation between these two sources is accounted for by the number of each type of facilities. Hospitals constitute 8% of the total in the MFL and 13% in WHO-KWTRP. Health centres form most of the facilities in the WHO-KWTRP list, 71%, while the closely related clinics only form 3%. In the MFL, there is more of an even spread of clinics and health centres, which constitute 39% and 35% respectively.  

```{r Types of facilities, echo=FALSE, fig.cap="Number of each type of facility in the MFL (top) and WHO-KWTRP (bottom), with proportions corresponding to ownership for each type coloured."}
# MFL
# Re-order the facility types
malawi_facilities_MFL$TYPE = as.factor(malawi_facilities_MFL$TYPE)

malawi_facilities_MFL$TYPE = factor(malawi_facilities_MFL$TYPE, levels = c("Central Hospital", "District Hospital", "Hospital", "Health Centre", "Clinic", "Health Post", "Dispensary", "Private", "Unclassified"))

# Number of each type + ownership
facility_types_MFL = as.data.frame(table(malawi_facilities_MFL$TYPE, malawi_facilities_MFL$OWNERSHIP))

# Only showing government, private and CHAM ownership
facility_types_MFL$new_Var2 = revalue(facility_types_MFL$Var2, c("Aquaid Lifeline"="Other", "Non-Government"="Other", "Parastatal"="Other", "Mission/Faith-based (other than CHAM)"="Other"))
facility_types_MFL$new_Var2 = factor(facility_types_MFL$new_Var2, levels = c("Government", "Private", "Christian Health Association of Malawi (CHAM)", "Other"))

## bar plot of no. of facility types 
plot_facility_types_MFL = ggplot(facility_types_MFL, aes(x=Var1, y=Freq, fill=new_Var2)) + geom_bar(position = "stack", stat = "identity")

plot_facility_types_MFL = plot_facility_types_MFL + labs(x = "Facility types", y = "Frequency", fill="Ownership") + scale_fill_brewer(palette = "Set2") + coord_flip() + theme_minimal() + ggtitle("MFL") + theme(axis.title.y = element_blank(), legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8), plot.title = element_text(face = "bold", hjust = 0), legend.position = "bottom") + expand_limits(y=c(0,600))

# WHO
# Re order facility types and ownership 
sf_malawi_WHO$`Facility type` = as.factor(sf_malawi_WHO$`Facility type`)
sf_malawi_WHO$`Facility type` = factor(sf_malawi_WHO$`Facility type`, levels = c("Central Hospital", "District Hospital", "Mission Hospital", "Rural Hospital", "Community Hospital", "Health Centre", "Clinic", "Health Post/Dispensary"))

sf_malawi_WHO$Ownership = as.factor(sf_malawi_WHO$Ownership)
sf_malawi_WHO$Ownership = factor(sf_malawi_WHO$Ownership, levels = c("MoH", "FBO", "Local authority", "NGO"))

# No. of original facility types + ownership
facility_types_WHO = as.data.frame(table(sf_malawi_WHO$`Facility type`, sf_malawi_WHO$Ownership))

## bar plot of original facility types 
plot_facility_types_WHO = ggplot(facility_types_WHO, aes(x=Var1, y=Freq, fill=Var2)) + geom_bar(position = "stack", stat = "identity")
plot_facility_types_WHO = plot_facility_types_WHO + labs(x = "Facility types", y = "Frequency", fill="Ownership") + scale_fill_brewer(palette = "Set2") + coord_flip() + theme_minimal() + ggtitle("WHO-KWTRP") + theme(axis.title.y = element_blank(), legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8), plot.title = element_text(face = "bold", hjust = 0), legend.position = "bottom") + expand_limits(y=c(0,600))


ggarrange(plot_facility_types_MFL, plot_facility_types_WHO, ncol = 1, nrow = 2, align = "v")

```  
  
Figure 3 shows the point locations of facilities from both sources and an interactive version with all facility types can be viewed online. By observing this map, it appears that the same central hospitals are recorded in both lists and majority of district hospitals, apart from 2, are also matching (figure 3). Distribution of the 3 other hospital categories in WHO-KWTRP is predominantly similar to that of 'hospital' in the MFL, with the exception of some central and southern districts. It also confirms the MFL has a significant number of clinics that are not accounted for in the WHO-KWRTP list, which only reports a small number in the central and southern regions (figure 4).  

```{r Maps, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Locations of central and district hospitals in the MFL and WHO-KWTRP."}

# Point locations - combined 
tmap_admin2 = tm_shape(st_geometry(malawi_admin2)) + tm_borders()

## subsetting WHO to get layers for each type of facility
## so distribution of each type can be compared
central_hosp_WHO = filter(sf_malawi_WHO, `Facility type` == "Central Hospital")
district_hosp_WHO = filter(sf_malawi_WHO, `Facility type` == "District Hospital")
mission_hosp_WHO = filter(sf_malawi_WHO, `Facility type` == "Mission Hospital")
rural_hosp_WHO = filter(sf_malawi_WHO, `Facility type` == "Rural Hospital")
community_hosp_WHO = filter(sf_malawi_WHO, `Facility type` == "Community Hospital")
health_centre_WHO = filter(sf_malawi_WHO, `Facility type` == "Health Centre")
clinic_WHO = filter(sf_malawi_WHO, `Facility type` == "Clinic")
post_disp_WHO = filter(sf_malawi_WHO, `Facility type` == "Health Post/Dispensary")

hosp3_WHO = rbind(mission_hosp_WHO, rural_hosp_WHO, community_hosp_WHO)

hosp3_WHO$`Facility type` = factor(hosp3_WHO$`Facility type`, levels = c("Mission Hospital", "Rural Hospital", "Community Hospital"))

cen_dis_hosp_WHO = rbind(central_hosp_WHO, district_hosp_WHO)

cen_dis_hosp_WHO$`Facility type` = as.factor(cen_dis_hosp_WHO$`Facility type`)

cen_dis_hosp_WHO$`Facility type` = factor(cen_dis_hosp_WHO$`Facility type`, levels = c("Central Hospital", "District Hospital"))

## map WHO
tmap_cen_dis_hosp_WHO = tmap_admin2 + tm_shape(cen_dis_hosp_WHO) + tm_dots(col = "Facility type", size = 0.15, palette = qualitative_hcl(2, palette = "Dark 2")) + tm_layout(asp = 2, title = "WHO-\nKWTRP", title.position = c("left", "top"), title.size = 1, title.fontface = "bold")

## same with MFL
central_hosp_MFL = filter(malawi_facilities_MFL, TYPE == "Central Hospital")
district_hosp_MFL = filter(malawi_facilities_MFL, TYPE == "District Hospital")
hosp_MFL = filter(malawi_facilities_MFL, TYPE == "Hospital")
health_centre_MFL = filter(malawi_facilities_MFL, TYPE == "Health Centre")
clinic_MFL = filter(malawi_facilities_MFL, TYPE == "Clinic")
post_MFL = filter(malawi_facilities_MFL, TYPE == "Health Post")
dispensary_MFL = filter(malawi_facilities_MFL, TYPE == "Dispensary")
priv_MFL = filter(malawi_facilities_MFL, TYPE == "Private")
un_MFL = filter(malawi_facilities_MFL, TYPE == "Unclassified")

cen_dis_hosp_MFL = rbind(central_hosp_MFL, district_hosp_MFL)

cen_dis_hosp_MFL$TYPE = as.factor(cen_dis_hosp_MFL$TYPE)

cen_dis_hosp_MFL$TYPE = factor(cen_dis_hosp_MFL$TYPE, levels = c("Central Hospital", "District Hospital"))

tmap_cen_dis_hosp_MFL = tmap_admin2 + tm_shape(cen_dis_hosp_MFL) + tm_dots(col = "TYPE", palette = qualitative_hcl(2, palette = "Dark 2"), size = 0.15, title = "Facility type") + tm_layout(asp = 2, title = "MFL", title.position = c("left", "top"), title.size = 1, title.fontface = "bold")

# tm_add_legend(type = "symbol", col = "mediumseagreen", labels = "Hospital", title = "Facility type", shape = 20)

tmap_cen_dis = tmap_arrange(tmap_facilities_MFL, tmap_facilities_WHO, ncol = 2)
tmap_cen_dis
```  

```{r Clinics, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Locations of clinics in the MFL and WHO-KWTRP."}
tmap_clinics_MFL = tmap_admin2 + tm_shape(clinic_MFL) + tm_dots(col = "deepskyblue4", size = 0.15, title = "Facility type") + tm_layout(asp = 2, title = "MFL", title.position = c("left", "top"), title.size = 1, title.fontface = "bold") + tm_add_legend(type = "symbol", col = "deepskyblue4", labels = "Clinic", title = "Facility type", shape = 20)

tmap_clinics_WHO = tmap_admin2 + tm_shape(clinic_WHO) + tm_dots(col = "deepskyblue4", size = 0.15, title = "Facility type") + tm_layout(asp = 2, title = "WHO-\nKWTRP", title.position = c("left", "top"), title.size = 1, title.fontface = "bold") + tm_add_legend(type = "symbol", col = "deepskyblue4", labels = "Clinic", title = "Facility type", shape = 20)

tmap_clinics = tmap_arrange(tmap_clinics_MFL, tmap_clinics_WHO, ncol = 2, nrow = 1)
tmap_clinics
```

```{r Interactive map, echo=FALSE, message=FALSE, warning=FALSE, fig.show='hide'}
tmap_facilities_WHO = tmap_admin2 + tm_shape(central_hosp_WHO) + tm_dots(col = "Facility type", size = 0.15, palette = qualitative_hcl(2, palette = "Dark 2")) + tm_layout(asp = 2, title = "WHO-\nKWTRP", title.position = c("left", "top"), title.size = 1, title.fontface = "bold")

```
  
Comparison between private faciltiies is also made here, as the WHO-KWTRP data does not include this. In the MFL, 30% of all facilities are privately owned. Majority consist of 356 clinics, 45 dispensaries and 16 hospitals. Distribution across the country indicates many are present in Blantyre and Lilongwe, with 95 and 67 private facilities respectively (figure 5).  
  
```{r Private MFL, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Number of private facilities per district in the MFL."}
private_MFL = filter(malawi_facilities_MFL, OWNERSHIP == "Private")
# 433 private facilities, 30.3%

# distribution 

malawi_admin2$private_MFL = lengths(st_intersects(malawi_admin2, private_MFL, sparse = TRUE))

tmap_private_district_MFL = tm_shape(malawi_admin2) + tm_borders() + tm_shape(malawi_admin2) + tm_fill("private_MFL",  palette = sequential_hcl(6, palette = "YlGnBu", rev = TRUE), title = "Private facilities") + tm_layout(asp = 0.5, legend.title.size = 1)
tmap_private_district_MFL

# which types are private?
private_MFL$TYPE = as.factor(private_MFL$TYPE)
types_private_MFL = as.data.frame(table(private_MFL$TYPE))
```
  

##### Hypothesis 3  

Within healthsites.io, 158 hospitals are recorded which is greater than both the MFL and WHO-KWTRP, with 117 and 82 hospitals respectively (figure 6). Healthsites.io does not provide a breakdown of hospitals into groups. A look into the distribution by district shows majority of the difference in hospital number is concentrated around 3 districts in the south (figure 7). Blantyre district has 39 hospitals in healthsites.io compared to 14 in the MFL and both its neighbouring Mwanza and Thyolo districts have 9 and 7 additional hospitals in healthsites.io respectively. Instances where the MFL has more hospitals in a district, the number does not exceed more than 4 facilities. A note here is that 4 hospitals in the MFL did not have accurate coordinates and so were dropped from the total of 117 in this analysis. 
  
```{r Hospital comparison, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Number of hospitals in each data source."}
# barplot
Hospitals = c(117, 82, 158)
Source2 = c("MFL", "WHO-KWTRP", "healthsites.io")

hosp_3sources = data.frame(Hospitals, Source2)

plot_hosp_3sources = ggplot(hosp_3sources, aes(x=Source2, y=Hospitals)) + geom_bar(stat = "identity", width = 0.6, fill="slategray") + labs(x = "Source of data", y = "Frequency") + theme_minimal() + expand_limits(y=c(0,200)) + coord_flip()
plot_hosp_3sources

```  

```{r Hospital comparison map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Number of hospitals per district from the MFL (left) and healthsites.io (right)."}
# plot of hospitals in healthsites.io
hosp_rhs = filter(malawi_rhs, amenity == "hospital")

tmap_facilities_rhs = tmap_admin2 + tm_shape(hosp_rhs) + tm_dots(col = "mediumseagreen") + tm_layout(frame = FALSE, asp = 2, title = "healthsites.io", title.position = c("left", "top"))

facilities_rhs = tmap_arrange(tmap_facilities_MFL, tmap_facilities_rhs, ncol = 2)

# districts
all_hosp_MFL = filter(malawi_facilities_MFL, TYPE == "Central Hospital" | TYPE == "District Hospital" | TYPE == "Hospital")

malawi_admin2$hosp_rhs = lengths(st_intersects(malawi_admin2, hosp_rhs, sparse = TRUE))
malawi_admin2$all_hosp_MFL = lengths(st_intersects(malawi_admin2, all_hosp_MFL, sparse = TRUE))
# 4 hospitals did not intersect


# plot

tmap_hosp_MFL = tm_shape(malawi_admin2) + tm_borders() + tm_shape(malawi_admin2) + tm_fill("all_hosp_MFL",  palette = sequential_hcl(6, palette = "YlGn", rev = TRUE), title = "Hospitals") + tm_layout(title = "MFL", title.size = 1, title.fontface = "bold")

tmap_hosp_rhs = tm_shape(malawi_admin2) + tm_borders() + tm_shape(malawi_admin2) + tm_fill("hosp_rhs",  palette = sequential_hcl(6, palette = "YlGnBu", rev = TRUE), title = "Hospitals") + tm_layout(title = "healthsites.\nio", title.size = 1, title.fontface = "bold")

hosp_MFL_rhs = tmap_arrange(tmap_hosp_MFL, tmap_hosp_rhs, ncol = 2)
hosp_MFL_rhs
```  


##### Blantyre  

talk about distribution of facilities in MFL and WHO across Blantyre (rural & city differences)  
(23 private facilities did not intersect)  
talk about private in Blantyre  
talk about hospitals in Blantyre  



```{r Blantyre facilities, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Distribution of facilities present in Blantyre district from both the MFL and WHO-KWTRP."}
# district for each facility
intersect_admin2_MFL = st_intersection(malawi_facilities_MFL, malawi_admin2)
blantyre_intersect_admin2_MFL = filter(intersect_admin2_MFL, shapeName == "Blantyre")

# admin3 levels
blantyre_admin2 = filter(malawi_admin2, shapeName == "Blantyre")
blantyre_admin3 = st_intersection(malawi_admin3, blantyre_admin2)

blantyre_city_admin3 = filter(blantyre_admin3, shapeName == "Michiru Ward" | shapeName == "South Lunzu Ward" | shapeName == "Mapanga Ward" | shapeName == "Nkolokoti Ward" | shapeName == "Ndirande Norh Ward" | shapeName == "Ndirande South Ward" | shapeName == "Ndirande West Ward" | shapeName == "Likhubula Ward" | shapeName == "Chilomoni Ward" | shapeName == "Blantyre West Ward" | shapeName == "Chichiri Ward" | shapeName == "Blantyre Central Ward" | shapeName == "Blantyre East Ward" | shapeName == "Mzedi Ward" | shapeName == "Bangwe Ward" | shapeName == "Namiyango Ward" | shapeName == "Limbe East Ward" | shapeName == "Limbe Central Ward" | shapeName == "Limbe west Ward" | shapeName == "Soche East Ward" | shapeName == "Soche West Ward" | shapeName == "Nancholi Ward" | shapeName == "Misesa" | shapeName == "Chigumula Ward" | shapeName == "Msamba Ward")

## 
intersect_admin2_WHO = st_intersection(sf_malawi_WHO, malawi_admin2)
blantyre_intersect_admin2_WHO = filter(intersect_admin2_WHO, shapeName == "Blantyre")

# maps of blantyre 
tmap_blantyre_MFL =  tm_shape(blantyre_admin3) + tm_borders() + tm_shape(blantyre_city_admin3) +tm_borders(lwd = 3) + tm_shape(filter(malawi_admin2, shapeName == "Blantyre")) + tm_borders() + tm_shape(blantyre_intersect_admin2_MFL) + tm_dots(col = "TYPE", size = 0.2) + tm_layout(title = "MFL", title.size = 1, title.fontface = "bold")

 # 154 facilities in total

tmap_blantyre_WHO =  tm_shape(blantyre_admin3) + tm_borders() + tm_shape(blantyre_city_admin3) +tm_borders(lwd = 3) + tm_shape(filter(malawi_admin2, shapeName == "Blantyre")) + tm_borders() + tm_shape(blantyre_intersect_admin2_WHO) + tm_dots(col = "Facility.type", size = 0.2) + tm_layout(title = "WHO-\nKWTRP", title.size = 1, title.fontface = "bold")

 # 31 facilities in total

tmap_arrange(tmap_blantyre_MFL, tmap_blantyre_WHO)
```
  
```{r Blantyre private, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Distribution of private facilities in Blantyre district obtained from the MFL."}
# filter out private facilities 
private_intersect_admin2_MFL = filter(intersect_admin2_MFL, OWNERSHIP == "Private")
blantyre_private_intersect_admin2_MFL = filter(private_intersect_admin2_MFL, shapeName == "Blantyre")

blantyre_private_intersect_admin2_MFL$TYPE = as.factor(blantyre_private_intersect_admin2_MFL$TYPE)

blantyre_private_intersect_admin2_MFL$TYPE = factor(blantyre_private_intersect_admin2_MFL$TYPE, levels = c("Hospital", "Health Centre", "Clinic"))

tmap_private_blantyre = tm_shape(blantyre_admin3) + tm_borders() + tm_shape(blantyre_city_admin3) +tm_borders(lwd = 3) + tm_shape(filter(malawi_admin2, shapeName == "Blantyre")) + tm_borders() + tm_shape(blantyre_private_intersect_admin2_MFL) + tm_dots(col = "TYPE", palette = qualitative_hcl(3, palette = "Dark 2"), size = 0.2, title = "Facility type") + tm_layout(title = "Private facilities", legend.outside = TRUE, title.size = 1, title.fontface = "bold")
tmap_private_blantyre

 # 9 hospitals, 3 health centres, 83 clinics

# MFL - 27 facilities outside city 
# WHO - 17 facilities outside city 
```  

```{r Blantyre hospitals, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="A. Distribution of MFL hospitals and facilities labelled hospital with the amenity tag from healthsites.io in Blantyre district. B. Distribution of MFL hospitals and facilities labelled hospital with the healthcare tag from healthsites.io in Blantyre district."}
# hospitals in blantyre
hosp_intersect_admin2_MFL = filter(intersect_admin2_MFL, TYPE == "Hospital" | TYPE == "Central Hospital" | TYPE == "District Hospital")
blantyre_hosp_intersect_admin2_MFL = filter(hosp_intersect_admin2_MFL, shapeName == "Blantyre")
blantyre_hosp_intersect_admin2_MFL$hospital = replicate(14, "hospital")

## intersect rhs
intersect_admin2_rhs = st_intersection(malawi_rhs, malawi_admin2)

## filter for hospitals using amenity tag & Blantyre
hosp_intersect_admin2_rhs = filter(intersect_admin2_rhs, amenity == "hospital")
blantyre_hosp_intersect_admin2_rhs = filter(hosp_intersect_admin2_rhs, shapeName == "Blantyre")

tmap_hosp_blantyre =  tm_shape(blantyre_admin3) + tm_borders() + tm_shape(blantyre_city_admin3) +tm_borders(lwd = 3) + tm_shape(filter(malawi_admin2, shapeName == "Blantyre")) + tm_borders() + tm_shape(blantyre_hosp_intersect_admin2_MFL) + tm_dots(col = "hospital", palette="red", title = "MFL", size = 0.2) + tm_shape(blantyre_hosp_intersect_admin2_rhs) + tm_dots(col = "amenity",title = "Amenity tag", palette="darkgreen", size = 0.2) + tm_layout(title = "A", title.size = 1, title.fontface = "bold", legend.title.size = 1, legend.position = c("left", "bottom"))

# 14 mfl hospitals and 39 in healthsites 

## filter hospitals using healthcare tag
health_intersect_admin2_rhs = filter(intersect_admin2_rhs, healthcare == "hospital") # 74 in total
blantyre_health_intersect_admin2_rhs = filter(health_intersect_admin2_rhs, shapeName == "Blantyre")

tmap_hosp_health_blantyre =  tm_shape(blantyre_admin3) + tm_borders() + tm_shape(blantyre_city_admin3) +tm_borders(lwd = 3) + tm_shape(filter(malawi_admin2, shapeName == "Blantyre")) + tm_borders() + tm_shape(blantyre_hosp_intersect_admin2_MFL) + tm_dots(col = "hospital", palette="red", title = "MFL", size = 0.2) + tm_shape(blantyre_health_intersect_admin2_rhs) + tm_dots(col = "healthcare",palette="darkgreen", title = "Healthcare tag", size = 0.2) + tm_layout(title = "B", title.size = 1, title.fontface = "bold", legend.title.size = 1, legend.position = c("left", "bottom"))
# 21 in healthsites 

# table for Blantyre in healthsites.io
blantyre_rhs = filter(intersect_admin2_rhs, shapeName == "Blantyre") # 49 facilities total

tmap_arrange(tmap_hosp_blantyre, tmap_hosp_health_blantyre)
```    

\newpage

##### Discussion  
  
  This report conveys a number of differences between these facility lists for Malawi and highlights the issues of missing/duplicate values. A small number of facilities were removed from each source as a consequence, which is often not done in research utilising these lists (Hulland et al., 2019). However as mentioned, the search for duplicate coordinates, particularly in the MFL, produced many hits yet these were not removed due to different facilities being accounted for by these locations. Its removal would have larger effects on the proportions of facility types. Although this is subjective and the need for proper validation processes in the MFL is emphasised. 

The guidance put together by WHO on the production of a MFL, recommends that district officers or individuals that have access to facilities in their areas be responsible for their validation. This can either be done through visits or telephone calls after which unique identifiers can be assigned (WHO, 2019b). On the Master Health Facility Registry website that hosts the MFL, it mentions that only users with ‘access control rights’ are able to add or edit facilities (MOH, 2021). This indicates there are filters in place that prevent validation from just anyone. However, whether a facility is validated prior to its open release is not mentioned and validation cannot be asserted by viewing a facility online or in the data downloaded. A case in the Philippines, where workshops were organised to bring together Department of Health staff to validate all the facilities in their MFL, shows how a different method might be needed to encourage this process (WHO, 2019b). More than the MFL, healthsites.io also contained many duplicates despite their outline for a validation index (Healthsites, 2021b). Often those facilities were inputted by the same user and at the exact same time, suggesting a possible error in the system. Another issue prominent was misclassification of facilities, in particular they being labelled as hospitals. 

On the Wikipedia page of healthsites.io, intended as information for volunteers looking to input facilities, it states that the healthcare and amenity columns include entries on the type of facilities and should be identical (Healthsites, 2021c). However, this was not the case for Malawi and there were a number still labelled as hospital despite their names suggesting otherwise. Instructions on classification are provided on the Wikipedia page, with hospitals relating to facilities offering specialised care and overnight stays while clinics refer to a medical centre with doctors that offer outpatient care (Healthsites, 2021d). In total, healthsites.io gives the option of 5 classifications while the WHO-KWTRP and the MFL data allow for 8 and 9 classes respectively. The WHO-KWTRP data referred to country specific Health Sector Strategic Plans (HSSPs) to define health facilities for each country (Maina et al., 2019). However, it still does not match with the MFL in the case of Malawi, adding another method of classification to consider. These differences make comparison difficult, especially with lower level facilities, when classifications are not uniform and not apparently accessible. One issue is difference in methods, but volunteers tagging a facility incorrectly is also a problem in the case of healthsites.io and further shows the need for validation. A recent study measuring global access to healthcare used data from healthsites.io as well the WHO-KWTRP data and stated only the use of hospitals and clinics (Weiss et al., 2020). Incorrect tagging would have affected the results of this research and potentially inflated the number of hospitals, as is shown in this look into Malawi. 

Research using Malawi facility data should also consider the number of private facilities not captured by WHO-KWTRP. Most of these consist of clinics with Blantyre district hosting the largest number. Blantyre is the second largest district in terms of population, around 1 million, of which nearly 60% is estimated to be urban (Mzilahowa et al., 2016). Facilities in rural areas that are not accounted for can impact accessibility measurements and private clinics make up most of the difference between total numbers of WHO-KWTRP and MFL facilities in rural Blantyre. Maina et al., state their reason for exclusion being difficulty in auditing and identifying these facilities. However, 30% is not an insignificant number and stakeholders or researchers need to consider whether to use the WHO-KWTRP data when the additional facilities are not limited to urban areas. Date of data collection is also a potential reason for the discrepancy in total number. As mentioned, the WHO has not updated their list since early 2019 and while MFL updates can be viewed when clicking on specific facilities, it is hard to determine the dates of when facilities have been added to the MFL. A random browse through their site shows the most recent updates span 2019 and early 2020.  

- Why is healthsites much less & is it used often in research?
- Distribution of the differences and effect on research  
- Attributes -> why they are important and lack of them in lists  
- Conclusion
 



  

























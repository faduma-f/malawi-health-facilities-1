---
title: "02 Selection"
author: '35762384'
date: "17/02/2021"
output: 
  html_document: 
    keep_md: yes
    code_folding: show  
---  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(sf)
library(readxl)
library(dplyr)
library(plyr)
library(ggplot2)
library(afrihealthsites)
library(ggpubr)
library(afriadmin)
library(tmap)
library(forcats)
library(cowplot)
library(colorspace)
library(readr)
library(waffle)
library(sunburstR)
library(htmltools)
library(htmlwidgets)

# Install Malawi MFL
malawi_MFL = read_excel("~/malawi-health-facilities-1/MHFR_Facilities 1.xlsx")

# Convert to sf

## omit NA's
new_malawi_MFL = na.omit(malawi_MFL)

## transform geometry columns into numeric 
new_malawi_MFL = transform(new_malawi_MFL, LATITUDE = as.numeric(LATITUDE), 
                                           LONGITUDE = as.numeric(LONGITUDE))

## convert to sf object
malawi_facilities_MFL = st_as_sf(new_malawi_MFL, coords = c("LONGITUDE", "LATITUDE"), dim = "XY")

malawi_facilities_MFL = st_set_crs(malawi_facilities_MFL, 4326)

malawi_WHO <- afrihealthsites("malawi", datasource='who', plot=FALSE, returnclass='dataframe')
malawi_WHO = malawi_WHO[ , -10]
```  

#### Introduction  
The availability of health facility data, such as location, capacity and resources present, is an important factor needed for decision-making processes, especially in the ongoing COVID-19 pandemic. Examples of uses include planning of interventions, disease surveillance, information for insurance companies and health management information systems (HMIS) (WHO, 2018). It is also often used for research purposes, with many studies utilising facility data to determine accessibility to healthcare or travel times (Hulland et al., 2019). However, availability is often not the issue but the fact that there are multiple sources and the discrepancies between them (Makinde et al., 2018). It is common for different organisations, e.g. non-governmental organisations (NGOs), government departments and other non-profit organisations, to produce their own lists and a need to further investigate differences is noted in studies using this data (Hulland, 2020). The aim of this paper is to do address this point; to analyse and highlight the differences between sources of facility data using Malawi as a case study and mark areas for improvement in the quality of the data.

One source for Malawi is a list compiled by the Kenyan Wellcome Trust Research Programme (KWTRP) for 50 sub-Saharan African countries and was released in 2019 (Maina et al., 2019). It focused on public health facilities, those run by the government, faith-based organisations (FBOs) and NGOs. It’s availability as open-access data as well as the thorough cleaning and validation processes that were implemented, meant it was often cited in other studies (Falchetta et al., 2020)(Judson et al., 2020)(Dowhaniuk, 2021)(Wariri et al., 2021). …

Another source is the Master Facility List (MFL) from and managed by the Malawi Ministry of Health (Ministry of Health Malawi, 2021) … 

Other sources include … 

Quality data is important but this is often neglected or not investigated. There are several
issues that are prominent with facility data from sub-Saharan Africa. Lists are often missing key elements such as capacity, equipment and services they provide. … Problems are present but not accounted for/discussed/highlighted but this is important for research that follows this. … The fact that there are multiple sources makes this more difficult. … with the outbreak of COVID-19, there is a greater emphasis on the importance of this. Several countries have allowed open access to their facility data, encouraging external research to aid the response to the pandemic and improvement of the data itself (South et al., 2021). For example, research investigating the ability of health facilities to increase capacity and the identification of people vulnerable due to various factors in Kenya were performed with open facility data (Barasa et al., 2020) (Macharia et al., 2020). Therefore, maintenance and quality control of facility lists are essential in providing accurate data and contributing to valid research. 

Ending paragraph ... 

##### Methods  
- Websites from where I downloaded  
- What was done to the data pre-analysis, e.g. removing NAs  
- Software used (packages?)  

##### Results  

In total, there are 1546 facilities recorded in the MFL and 648 in the WHO-KWTRP data. The MFL and the WHO-KWTRP lists contain 9 and 7 other attributes respectively in addition to coordinate data (figure 1). In the MFL, functional status of facilities, date opened and districts the facilities reside in are included. Two variations for the names are also stated while in the WHO-KWTRP list, there is one column for names and only first level administration regions for each facility are provided, which in Malawi consists of Northern, Central and Southern regions. 
```{r Data tables, echo=FALSE}
head(malawi_MFL)
head(malawi_WHO)
```

- Facility plots 

```{r Facility plots, echo=FALSE, message=FALSE, warning=FALSE}
# MFL
# Re-order the facility types
malawi_MFL$TYPE = as.factor(malawi_MFL$TYPE)

malawi_MFL$TYPE = factor(malawi_MFL$TYPE, levels = c("Central Hospital", "District Hospital", "Hospital", "Health Centre", "Clinic", "Health Post", "Dispensary", "Private", "Unclassified"))

# Number of each type + ownership
facility_types_MFL = as.data.frame(table(malawi_MFL$TYPE, malawi_MFL$OWNERSHIP))

# Only showing government, private and CHAM ownership
facility_types_MFL$new_Var2 = revalue(facility_types_MFL$Var2, c("Aquaid Lifeline"="Other", "Non-Government"="Other", "Parastatal"="Other", "Mission/Faith-based (other than CHAM)"="Other"))
facility_types_MFL$new_Var2 = factor(facility_types_MFL$new_Var2, levels = c("Government", "Private", "Christian Health Association of Malawi (CHAM)", "Other"))


## bar plot of no. of facility types 
plot_facility_types_MFL = ggplot(facility_types_MFL, aes(x=Var1, y=Freq, fill=new_Var2)) + geom_bar(position = "stack", stat = "identity")

plot_facility_types_MFL = plot_facility_types_MFL + labs(x = "Facility types", y = "Frequency", fill="Ownership") + scale_fill_brewer(palette = "Set2") + coord_flip() + theme_minimal() + ggtitle("MFL") + theme(axis.title.y = element_blank(), legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8), plot.title = element_text(face = "bold", hjust = 0), legend.position = "bottom")

# WHO
# Re order facility types and ownership 
malawi_WHO$`Facility type` = as.factor(malawi_WHO$`Facility type`)
malawi_WHO$`Facility type` = factor(malawi_WHO$`Facility type`, levels = c("Central Hospital", "District Hospital", "Mission Hospital", "Rural Hospital", "Community Hospital", "Health Centre", "Clinic", "Health Post/Dispensary"))

malawi_WHO$Ownership = as.factor(malawi_WHO$Ownership)
malawi_WHO$Ownership = factor(malawi_WHO$Ownership, levels = c("MoH", "FBO", "Local authority", "NGO"))

# No. of original facility types + ownership
facility_types_WHO = as.data.frame(table(malawi_WHO$`Facility type`, malawi_WHO$Ownership))

## bar plot of original facility types 
plot_facility_types_WHO = ggplot(facility_types_WHO, aes(x=Var1, y=Freq, fill=Var2)) + geom_bar(position = "stack", stat = "identity")
plot_facility_types_WHO = plot_facility_types_WHO + labs(x = "Facility types", y = "Frequency", fill="Ownership") + scale_fill_brewer(palette = "Set2") + coord_flip() + theme_minimal() + ggtitle("WHO") + theme(axis.title.y = element_blank(), legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8), plot.title = element_text(face = "bold", hjust = 0), legend.position = "bottom") + expand_limits(y=c(0,600))

plot_facilities = align_plots(plot_facility_types_MFL, plot_facility_types_WHO, align = "v")
ggdraw(plot_facilities[[1]])
ggdraw(plot_facilities[[2]])
```

- Maps 
```{r, echo=FALSE, message=FALSE, fig.show='hide', warning=FALSE}
malawi_admin1 = afriadmin("malawi", level = 1, plot = "sf")
malawi_admin2 = afriadmin("malawi",level=2, plot='sf')

new_malawi_WHO = na.omit(malawi_WHO) ## omit NA

sf_malawi_WHO = st_as_sf(new_malawi_WHO, coords = c("Long", "Lat"), dim = "XY")
sf_malawi_WHO = st_set_crs(sf_malawi_WHO, 4326)

tmap_mode("view")
```


```{r Maps, message=FALSE, echo=FALSE, warning=FALSE}
# MFL 
facility_admin2_MFL = st_intersects(malawi_admin2, malawi_facilities_MFL, sparse = TRUE)
malawi_admin2$facility = lengths(facility_admin2_MFL)

tmap_admin2_MFL = tm_shape(st_geometry(malawi_admin2)) + tm_borders() + tm_shape(malawi_admin2) + tm_fill("facility", palette = sequential_hcl(6, palette = "YlGnBu", rev = TRUE), title = "MFL facilities") + tm_layout(title = "MFL")

tmap_admin2_MFL

# WHO
facility_admin2_WHO = st_intersects(malawi_admin2, sf_malawi_WHO, sparse = TRUE)
malawi_admin2$facility_WHO = lengths(facility_admin2_WHO)

tmap_admin2_WHO = tm_shape(st_geometry(malawi_admin2)) + tm_borders() + tm_shape(malawi_admin2) + tm_fill("facility_WHO", palette = sequential_hcl(4, palette = "YlGnBu", rev = TRUE), title = "WHO facilities")

tmap_admin2_WHO

# Point locations - combined 

tmap_admin2 = tm_shape(st_geometry(malawi_admin2)) + tm_borders()

tmap_facilities_WHO = tmap_admin2 + tm_shape(sf_malawi_WHO) + tm_dots(col = "Facility type", palette = "-viridis") + tm_layout(frame = FALSE, asp = 2, title = "WHO", title.position = c("left", "top"))

tmap_facilities_MFL_WHO = tmap_facilities_WHO + tm_shape(malawi_facilities_MFL) + tm_dots(col = "TYPE", palette = "-YlOrRd", alpha = 0.7) + tm_layout(frame = FALSE, asp = 2, title = "MFL & WHO", title.position = c("left", "top"))

tmap_facilities_MFL_WHO
```
  
###### Missing values/wrong coordinates  

- 181 in the MFL (this includes NA's and coordinates that did not intersect with admin levels) and 9 in the WHO data. None are the same facilities/share same names. 
```{r NAs in data, message=FALSE, warning=FALSE}
# MFL - 1546 before omitting NA's, then 1427.
# 62 coordinates did not intersect with admin data - now 1365

# using anti_join() to see which facilities were omitted 
df_malawi_facilities_MFL = as.data.frame(malawi_facilities_MFL) # convert to data frame to use in anti_join

NA_MFL = anti_join(malawi_MFL, df_malawi_facilities_MFL) # 119 missing coordinates in MFL

# adding the number of wrong coordinates - 61
intersect_admin1_MFL = st_intersection(malawi_facilities_MFL, malawi_admin1) # returns data frame of matches

intersect_admin1_MFL = as.data.frame(intersect_admin1_MFL) # convert to data frame to use in anti_join

no_intersect_admin1_MFL = anti_join(malawi_facilities_MFL, intersect_admin1_MFL) # working out which facilities did not intersect

no_intersect_admin1_MFL_1 = no_intersect_admin1_MFL[ ,-c(10, 11)]
NA_MFL_1 = NA_MFL[, -c(10, 11)]
no_intersect_admin1_MFL_1 = st_set_geometry(no_intersect_admin1_MFL_1, NULL)
names(NA_MFL_1)[3] = "COMMON.NAME"
names(NA_MFL_1)[9] = "DATE.OPENED"

NA_MFL = rbind(NA_MFL_1, no_intersect_admin1_MFL_1) # combined dataframe of NA and wrong coordinates in MFL

# WHO - 648 with 9 missing coordinates, now 639
NA_WHO = anti_join(malawi_WHO, new_malawi_WHO)
```
  
###### Proportion that are privately owned in the MFL data  

- 30.3% of facilities are privately owned (433/1427)  
- Top 3 types are clinics (356), dispensaries (45) and hospitals (16)  
```{r Private facilities}
private_MFL = filter(malawi_facilities_MFL, OWNERSHIP == "Private")
# 433 private facilities, 30.3%

# which types are private?
private_MFL$TYPE = as.factor(private_MFL$TYPE)
types_private_MFL = as.data.frame(table(private_MFL$TYPE))
types_private_MFL
```  

###### Duplicates within dataset  

- 22 names in MFL appear more than once, of these Mpepa Health Centre (2 decimal places), Liwonde Medical Clinic (identical), Ngatala Health Post (3 decimal places), Cape Maclear (identical) and LIFE STYLE PVT CLINIC (identical) have similar/same coordinates 
- Of these, Ngatala, Cape Maclear and LIFE STYLE PVT CLINIC are most likely the same entries as other attributes are also the same. The other facilities differ in type and so might not be duplicates. 
- 10 names in WHO appear more than once, Mkango Health Centre has same coordinates (4 decimal places) and other attributes are also the same  

- Duplicate coordinates: in the MFL, 44 coordinates have been repeated at least more than once.  
Interesting note is that 24 facilities in Blantyre have reused the same coordinates (34.3015278, -13.2512161) and they consist of 1 hospital and a mix of clinics and health centres.  All have unique names as well.  
Same coordinates (33.7895208991213, -14.0017665100358) have also been used for 4 facilities, all in different districts.  
Some results are due to no coordinates being available and (-1,1) for example is inputted instead.  
No duplicates in the WHO data  

- Duplicates between datasets?  
```{r Duplicates}
# MFL
duplicate_name_MFL = malawi_facilities_MFL[malawi_facilities_MFL$NAME %in% malawi_facilities_MFL$NAME[duplicated(malawi_facilities_MFL$NAME)], ]

# WHO 
duplicate_name_WHO = new_malawi_WHO[new_malawi_WHO$`Facility name` %in% new_malawi_WHO$`Facility name`[duplicated(new_malawi_WHO$`Facility name`)], ]

# Same coordinates within dataset

## MFL 
duplicate_coord_MFL = malawi_facilities_MFL[malawi_facilities_MFL$geometry %in% malawi_facilities_MFL$geometry[duplicated(malawi_facilities_MFL$geometry)], ]

## WHO 
sf_malawi_WHO$geometry[duplicated(sf_malawi_WHO$geometry)] # none 

```

###### Proportion that are Government or Faith-based owned  
- 47.7% in MFL are Government owned  
- 15.4% in MFL are Faith-based owned (includes CHAM)  
- In WHO, 72.5% are Government owned  
- In WHO, 26.3% are Faith-based owned  

###### Which facilities are included in the MFL that aren't in the WHO  
- 419 facilities with the same name between MFL and WHO, 1008 facilities with different names  
- 219 facilities in WHO with no matches in MFL, looking at those, some are present in MFL but in lower caps or named slightly differently  
- 
```{r}
# MFL
anti_name_MFL_WHO = anti_join(new_malawi_MFL, new_malawi_WHO, by = c("NAME" = "Facility name"))
semi_name_MFL_WHO = semi_join(new_malawi_MFL, new_malawi_WHO, by = c("NAME" = "Facility name"))

# WHO
anti_name_WHO_MFL = anti_join(new_malawi_WHO, new_malawi_MFL, by = c("Facility name" = "NAME"))
semi_name_WHO_MFL = semi_join(new_malawi_WHO, new_malawi_MFL, by = c("Facility name" = "NAME"))

```  



















